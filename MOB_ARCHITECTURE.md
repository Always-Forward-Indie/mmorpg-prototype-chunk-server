# Архитектура управления мобами

## Обзор

Система управления мобами была рефакторизована для разделения ответственности между различными компонентами:

## Компоненты

### 1. MobManager
**Ответственность:** Управление шаблонами мобов (типы из базы данных)
- Загрузка типов мобов из БД
- Предоставление базовых характеристик мобов
- Атрибуты и свойства типов мобов

**Основные методы:**
- `getMobById(int mobId)` - получить шаблон моба по типу
- `setListOfMobs()` - загрузить типы мобов из БД

### 2. MobInstanceManager
**Ответственность:** Управление живыми экземплярами мобов в игровом мире
- Регистрация новых экземпляров мобов
- Обновление состояния мобов (здоровье, мана, позиция)
- Отслеживание мобов по зонам
- Управление жизненным циклом мобов

**Основные методы:**
- `registerMobInstance(mob)` - регистрация нового экземпляра
- `unregisterMobInstance(uid)` - удаление экземпляра
- `getMobInstance(uid)` - получение экземпляра по UID
- `updateMobHealth(uid, health)` - обновление здоровья
- `updateMobMana(uid, mana)` - обновление маны
- `updateMobPosition(uid, position)` - обновление позиции
- `getMobInstancesInZone(zoneId)` - получение мобов в зоне
- `isMobAlive(uid)` - проверка жив ли моб
- `markMobAsDead(uid)` - пометить моба как мертвого

### 3. MobMovementManager
**Ответственность:** Управление движением мобов
- Вычисление новых позиций мобов с учетом AI логики
- Обнаружение коллизий между мобами
- Проверка границ зон и удержание мобов в пределах зон
- Настройка параметров движения для различных зон

**Основные методы:**
- `moveMobsInZone(zoneId)` - движение всех мобов в зоне
- `moveSingleMob(mobUID, zoneId)` - движение одного моба
- `setZoneMovementParams(zoneId, params)` - настройка параметров движения зоны

### 4. SpawnZoneManager
**Ответственность:** Управление зонами спавна и процессом спавна
- Загрузка конфигурации зон спавна
- Спавн новых мобов в зонах
- Управление респавном мобов

**Основные методы:**
- `spawnMobsInZone(zoneId)` - спавн мобов в зоне
- `mobDied(zoneId, mobUID)` - обработка смерти моба
- `getMobSpawnZoneByID(zoneId)` - получение данных зоны
- Регистрирует новые экземпляры мобов в MobInstanceManager при спавне
- `mobDied(zoneId, mobUID)` - обработка смерти моба
- `getMobByUID(uid)` - получение моба (делегирует в MobInstanceManager)

### 4. CombatEventHandler
**Ответственность:** Обработка боевых действий
- Теперь использует MobInstanceManager для работы с мобами
- Применение урона/лечения через MobInstanceManager
- Получение информации о мобах через MobInstanceManager

## Поток данных

### Спавн моба:
1. `SpawnZoneManager.spawnMobsInZone()` получает шаблон из `MobManager`
2. Создает экземпляр моба с уникальным UID
3. Регистрирует экземпляр в `MobInstanceManager`
4. Добавляет в локальные списки зоны

### Боевые действия:
1. `CombatEventHandler` получает экземпляр моба из `MobInstanceManager`
2. Применяет изменения через `MobInstanceManager.updateMobHealth()`
3. `MobInstanceManager` обновляет состояние и логирует изменения

### Движение мобов:
1. `MobMovementManager.moveMobsInZone()` получает мобов из `MobInstanceManager`
2. Вычисляет новые позиции с учетом коллизий и зон
3. Обновляет позицию через `MobInstanceManager.updateMobPosition()`
4. `MobInstanceManager` синхронизирует с локальными списками в `SpawnZoneManager`

### Смерть моба:
1. `SpawnZoneManager.mobDied()` удаляет моба из локальных списков
2. Вызывает `MobInstanceManager.unregisterMobInstance()`
3. Уменьшает счетчик живых мобов в зоне

## Преимущества новой архитектуры

1. **Разделение ответственности:** Каждый компонент отвечает за свою область
2. **Централизованное управление:** Все экземпляры мобов управляются в одном месте
3. **Производительность:** Быстрый поиск мобов по UID и зонам
4. **Масштабируемость:** Легко добавлять новые функции для работы с мобами
5. **Отладка:** Централизованное логирование всех изменений состояния мобов
6. **Безопасность потоков:** Все операции защищены мьютексами

## Идентификаторы

- **mob.id** (int) - тип моба (из БД, одинаковый для всех экземпляров типа)
- **mob.uid** (int) - уникальный идентификатор экземпляра моба (генерируется при спавне)
- Для боевых действий всегда используется **uid**
- Для получения шаблонов характеристик используется **id**

## Примеры использования

### Нанесение урона мобу:
```cpp
// В CombatEventHandler
auto mobInstance = gameServices_.getMobInstanceManager().getMobInstance(targetUID);
if (mobInstance.uid != 0) {
    gameServices_.getMobInstanceManager().updateMobHealth(targetUID, newHealth);
}
```

### Получение мобов в зоне:
```cpp
// Получение всех живых мобов в зоне
auto mobsInZone = gameServices_.getMobInstanceManager().getMobInstancesInZone(zoneId);
```

### Проверка жив ли моб:
```cpp
if (gameServices_.getMobInstanceManager().isMobAlive(mobUID)) {
    // Моб жив, можно атаковать
}
```
